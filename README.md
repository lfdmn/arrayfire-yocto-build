# arrayfire-yocto-build

## Install pre-requisite packages on the build computer
```sh
sudo apt-get install gawk curl git-core git-lfs diffstat unzip texinfo build-essential \
chrpath libsdl1.2-dev xterm gperf bison gcc-multilib g++-multilib
```

## Checkout the sources
```sh
git clone --recursive https://github.com/lfdmn/arrayfire-yocto-build.git
```

## Download NVidia's sources
You need a devnet acount to fetch JetPack 4.3: https://developer.nvidia.com/jetpack-43-archive. 

Login/register and select ```Download SDK Manager```. Make sure to select JetPack 4.3 in ```Target Operating System```, and select ```Download now. Install Later.```

Initialize the build environment as described below and edit build-$MACHINE/conf/local.conf to add the location of the download folder, usually ```/home/$USER/Downloads/nvidia/sdkm_downloads```

```NVIDIA_DEVNET_MIRROR = "/home/{{your local user}}/Downloads/nvidia/sdkm_downloads"```

In that same local.conf, if you have a Ubuntu 16.04 based distro, uncomment ```CUDA_BINARIES_NATIVE = "cuda-binaries-ubuntu1604-native"```


## Initialize the buid environment
In order to build, you need to declare the MACHINE environment variable to define
the HW the image should be built for. I have prepared templates for:
* jetson TX2 devkit: MACHINE=jetson-tx2
* jetson xavier devkit: MACHINE=jetson-xavier

```sh
cd arrayfire-yocto-build
export MACHINE=jetson-xavier
source setup-environment.sh
```

## Building images
First build the core-image-minimal in order to have a good starting point and have all the cross compilation tools built.
```sh
cd arrayfire-yocto-build
export MACHINE=jetson-xavier
source setup-environment.sh
bitbake core-image-minimal
```

Now that core-image-minimal is built you can start working on arrayfire recipe.


## Arrayfire recipes
There are 2 recipes required:
* arrayfire-native: this one builds bin2cpp host (x86_64) utility required for the cross compilation
* arrayfire: builds the arrayfire package for aarch64


## Building individual recipes
An individual recipe can be build with 
```sh
bitbake arrayfire-native
bitbake arrayfire
```


## Patching recipes
The easiest way is to use devtool utility.
To start modifying a recipe
```sh
devtool modify arrayfire
```

A temporary repository is created in ```build-jetson-xavier/workspace/sources/arrayfire``` and this is becomes the source location for subsequent builds.

Once you are satisfied with the changes, git add/commit the modification to this local repository. 

Then use git format-patch to create the patches. 

Place a copy of the patches in ```sources/meta-test-distro/dynamic-layers/tegra/recipes-support/arrayfire/arrayfire_3.7.2/``` and add them to the SRC_URI variable in arrayfire_3.7.2.inc, arrayfire_3.7.2.bb or arrayfire-native_3.7.2.bb

Example in arrayfire_3.7.2.inc:
```
SRC_URI += " \
    file://0001-fix-main-cmakelists-txt-for-yocto-build.patch \
    file://0002-replace-space-characters-with-semicolon-in-CUDA_NVCC.patch \
"
```

Once you are done, reset the recipe with:
```sh
devtool reset arrayfire
bitbake arrayfire -c cleanall
```

And rebuild arrayfire with the new patched recipe:
```sh
bitbake arrayfire
```

## Building the test-image
```sh
cd arrayfire-yocto-build
export MACHINE=jetson-xavier
source setup-environment.sh
bitbake test-image
```

## Flashing the device
Connect the flashing USB port to your computer

Place your devkit in flashing mode:
* press and hold both power and force recovery buttons
* wait 2s
* release the force recovery button
* wait 2s
* release the power button

Here if you do check the USB devices, you should find one "NVidia Corp."
```sh
~$ lsusb
...
Bus 001 Device 045: ID 0955:7019 NVidia Corp.
...
```

The images generated by bitbake are in ```build-${MACHINE}/tmp/deploy/images/${MACHINE}/{{image name}}-${MACHINE}.tegraflash.zip```. Ex ```build-jetson-xavier/tmp/deploy/images/jetson-xavier/test-image-jetson-xavier.tegraflash.zip```

Unzip that zip file and run 
```sh
sudo ./doflash.sh
```

The device will reboot to the new image having arrayfire and arrayfire-python.


## SSH
You can SSH in the device at 192.168.1.100.
